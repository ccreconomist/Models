WITH MontoGrupo AS (
    SELECT 
        FECHA_CONSUMO,
        CASE
            WHEN IMP_DESTINO <= 250 THEN '$250'
            WHEN IMP_DESTINO > 250 AND IMP_DESTINO <= 500 THEN '$250 - $500'
            WHEN IMP_DESTINO > 500 AND IMP_DESTINO <= 750 THEN '$500 - $750'
            WHEN IMP_DESTINO > 750 AND IMP_DESTINO <= 1000 THEN '$750 - $1,000'
            ELSE '$1,000+'
        END AS GRUPO_DE_MONTOS,
        IMP_DESTINO
    FROM PROSA_510
    WHERE 
        FECHA_CONSUMO >= '2023-01-01 00:00:00.000' AND 
        FECHA_CONSUMO <= '2023-09-01 00:00:00.000' AND 
       ----- MCC_GIRO_COMERCIO = '07832' AND 
        TIPO_TRANSACCION = '01' AND 
        LEFT(NUM_CUENTA, 6) IN ('481281', '481284', '403750', '481282', '446351', '481283') AND
        RFC_COMERCIO = 'SSH 9608016NA'
)

SELECT 
    FECHA_CONSUMO,
    GRUPO_DE_MONTOS,
    COUNT(*) AS NUM_TRANSACCIONES,
    SUM(IMP_DESTINO) AS SUMA_IMP_DESTINO,
    SUM(IMP_DESTINO) / SUM(SUM(IMP_DESTINO)) OVER (PARTITION BY FECHA_CONSUMO) * 100 AS PORCENTAJE_POR_GRUPO
FROM MontoGrupo
GROUP BY FECHA_CONSUMO, GRUPO_DE_MONTOS
