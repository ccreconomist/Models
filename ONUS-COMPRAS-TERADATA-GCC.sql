SELECT
  NUM_CTA_CTAF AS Cuenta,
  RIGHT(NUM_CAR_CARF, 4) AS Tarjeta, -- Obtiene los últimos 4 caracteres de NUM_CAR_CARF
  T1.NUM_AUT_PRO,
  DAT_ADES_CTAF AS APROBADOS,
  DAT_TRANS_PRO AS FECHA,
  YEAR(FECHA) AS ANIO,
  MONTH(FECHA) AS MES,
  CASE
    WHEN COD_ORG_CTAF IN (310, 311, 320) THEN 'C&A'
    WHEN COD_ORG_CTAF IN (373, 353) THEN 'Suburbia'
    WHEN COD_ORG_CTAF IN (372, 352, 362) THEN 'Bodega'
    WHEN COD_ORG_CTAF IN (375, 355, 365) THEN 'Shasa'
    WHEN COD_ORG_CTAF IN (374, 354) THEN 'GCC'
    WHEN COD_ORG_CTAF IN (377, 357, 367) THEN 'Promoda'
    WHEN COD_ORG_CTAF IN (360) AND DAT_ADES_CTAF < '2020-06-01' THEN 'EFECTIVO'
    WHEN COD_ORG_CTAF IN (360) AND DAT_ADES_CTAF >= '2020-06-01' THEN 'GCC'
    ELSE 'OTRO'
  END SOCIO,
  CASE
    WHEN COD_ORG_CTAF IN (310, 311, 373, 372, 375, 374, 377) THEN 'PLCC'
    WHEN COD_ORG_CTAF IN (320, 353, 352, 355, 354, 357) THEN 'BK'
    WHEN COD_ORG_CTAF IN (340, 341, 360, 365, 367, 362) THEN 'PL'
    ELSE 'OTRO'
  END PRODUCTO,
  'C' AS TRANSACCION,
  VAL_TOT_DEST_PRO AS MONTO,
  CASE
    WHEN COD_ORG_CTAF IN (373, 353) AND RFC_ESTB_PRO IN ('SUB 910603SB3', 'AUR 9402236Y6', 'OCM 9511136Z1') AND NOM_ESTB_PRO LIKE '%SUBURBIA%' THEN 'ON'
    WHEN COD_ORG_CTAF IN (372, 352) AND RFC_ESTB_PRO = 'NWM 9709244W4' AND (NOM_ESTB_PRO LIKE 'B%' OR NOM_ESTB_PRO LIKE 'MI%') THEN 'ON'
    WHEN COD_ORG_CTAF IN (372, 352) AND RFC_ESTB_PRO = 'NWM 9709244W4' AND (
        COD_ESTB_PRO LIKE '%4163436' OR COD_ESTB_PRO LIKE '%4163435' OR COD_ESTB_PRO LIKE '%4302584' OR COD_ESTB_PRO LIKE '%8435228' OR
        COD_ESTB_PRO LIKE '%4392592' OR COD_ESTB_PRO LIKE '%4302592' OR COD_ESTB_PRO LIKE '%4194989' OR COD_ESTB_PRO LIKE '%4044712' OR
        COD_ESTB_PRO LIKE '%4180118' OR COD_ESTB_PRO LIKE '%8434689') THEN 'ON'
    WHEN COD_ORG_CTAF IN (375, 355) AND RFC_ESTB_PRO = 'SSH 9608016NA' THEN 'ON'
    WHEN COD_ORG_CTAF IN (375, 355) AND NOM_ESTB_PRO LIKE '%SHASA%' THEN 'ON'
    WHEN COD_ORG_CTAF IN (374, 354) AND RFC_ESTB_PRO = 'GCD 170101GS6' THEN 'ON'
    WHEN COD_ORG_CTAF IN (360) AND DAT_ADES_CTAF >= '2020-06-01' AND RFC_ESTB_PRO = 'GCD 170101GS6' THEN 'ON'
    WHEN COD_ORG_CTAF IN (377, 357) AND RFC_ESTB_PRO = 'MOS 150123565' THEN 'ON'
    ELSE 'OF'
  END TIPOTXN,
  CASE WHEN DAT_PRI_COM_CTAF = DAT_TRANS_PRO THEN 'P' ELSE 'R' END TIPOCOMPRA
FROM TRANSACAO_PROSA_V AS T1
INNER JOIN CARTAO_FINANCIAMENTO_V ON ID_CAR_PRO = ID_CAR_CARF
INNER JOIN CONTA_FINANCIAMENTO_V ON ID_CTA_CARF = ID_CTA_CTAF
WHERE COD_TIPO_TRANSACAO_PRO = 01
  AND DAT_TRANS_PRO >= '2023-10-20' AND DAT_TRANS_PRO <= '2023-10-25'
  AND COD_ORG_CTAF IN (374, 354)
  AND COD_ORG_CTAF IN (373, 353, 372, 352, 375, 355, 374, 354, 377, 357, 360, 362, 365, 367)
  AND SOCIO = 'GCC'
  AND TIPOTXN = 'ON';
